---
title: "Logboek_SV"
author: "Stijn Vermeulen"
date: "2024-11-20"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introductie

I will create a Data dashboard from data that discripes the effect of betuline acid on the methilation of promotor regions of some gene, primarialy the genes from the P53 pathway. This data was generated by students from Hanzehogeschool groningen.


*Nov 20 2024*

I recieved the data from the project manager, the data consist of two types of csv files: All reads or only regions of interest.

The All read files consist of 5 columns: chromosome, start and end position (which always seem to only include only 1 position.), a frac column and a valid column.

The regions of interest files have 3 columns: chromosome, position and gene.

In barcodes.csv are the types of patients given for each barcode (heathy, control, etc.).

Er staat geen gene colom in de all read files, wat vervelend is voor het filteren, Ramon Reilman (medestudent) heeft hier al een mail over gestuurt, dus als hij een reactie krijgt geeft hij dat door aan mij.

*Nov 21 2024*

Nu wil ik de data alsnog even op mijn repo hebben onder in de map 'data'. Dus ik copieer de data naar mijn repository ook al kan er een verandering aan komen, maar dan kopieer ik het wel opnieuw.

ik gebruik de code:
```{bash eval = FALSE}
scp user@bioinf.nl:/commons/Themas/Thema06/Methylatie/analysis ./
scp user@bioinf.nl:/commons/Themas/Thema06/Methylatie/barcodes.csv ./
```

Als visualisatie zat ik in ieder geval te denken aan het selecteren van een of meerdere chromosomen en een range van posities voor de promoter regio's. Na die selectie zou het waarschijnlijk fijn zijn om niet alle chromosomen tegelijk te zien, dus dan zou je kunnen wisselen tussen chromosoom visualisaties met een dropdown menu of iets. De plot die dan gevisualiseert wordt zou dan waarschijnlijk een barchart zijn met op de x-as de positie en op de y-as een %gemetileert of readcounts.

*Nov 26 2024*

Ik heb de bestanden met git lfs naar de git repository gepushed. Ik ga hier verder met het kijken naar de visualisatie van de bestanden:

Geef mijn al gegenereerde venv met [reticulate](https://rviews.rstudio.com/2019/06/10/reticulate-virtualenv-and-python-in-linux/):
```{r}
library("reticulate")
```


```{r}
use_virtualenv("../venv", required = T)
py_config()
```
*Nov 27 2024*
Importeer de benodigde library's:
```{python}
import pandas as pd
import matplotlib as mpl
import numpy as np
import os
import panel as pn
```

data inlezen
```{python}
bar_11_ALL = pd.read_csv("../Data/analysis/barcode11_methylatie_ALL.csv", sep="\t")
print(bar_11_ALL.head(10))
```

```{python}
bar_11_ROI = pd.read_csv("../Data/analysis/barcode11.methylatie_ROIs.csv", sep="\t", header=0, usecols=[0,1,2], names=["chr", "pos", "gene"])
print(bar_11_ROI.head(10))
```

Ik geef de colomen zelf op omdat bij de ROI data wordt de gene colom naam naar een NaN colom geschoven en de gene colom unnamed wordt.

Ik kan alle ROI en ALL data waarschijnlijk in een lijst of dictionary opslaan, ik ga dit alleen doen met de ROI's omdat die heel weinig informatie hebben en ik makkelijk op mijn eigen laptop kan processen.

Hiervoor wil ik de absolte paden hebben om de bestanden in te lezen. Dit kan ik doen met de config, maar ik kan met os misschien die ook zelf genereren:

```{python}
ROI_paths = [os.path.abspath(os.path.join("../Data/analysis/", path)) for path in os.listdir("../Data/analysis/") if path.endswith("ROIs.csv")]
print(ROI_paths)
ALL_paths = [os.path.abspath(os.path.join("../Data/analysis/", path)) for path in os.listdir("../Data/analysis/") if path.endswith("ALL.csv")]
print(ALL_paths)
```

Dit werkt, ik gebruik dezelfde code wel twee keer dus ik kan deze als een functie in mijn bestand zetten.

Ik wil deze bestanden wel in een enkele dataframe, met een extra colom die aangeeft van welke barcode het komt. Dit is makelijker als ik deze data als dict maak met de key's de barcode:

```{python}
# index op het absolute pad met negatieve waardes zodat mogelijke afwijkingen in het pad niet relevant is voor het indexen op de string.
ROI_data = {file[-29:-20]: (pd.read_csv(file, sep="\t", header=0, usecols=[0,1,2], names=["chr", "pos", "gene"])) for file in ROI_paths}

print(ROI_data)
```
Om een of andere reden is barcode 12 ROI leeg, en is er een rare volgorde van de barcodes, maar dat zou niet uit moeten maken.

*Nov 28 2024*

Ik denk dat het handig is om deze dictionary naar een dataframe combineer, maar dan is het misschien wel handig om nog een colom aan te maken voor het id.

*Dec 3 2024*
```{python}
full_ROI_data = pd.DataFrame(columns=["chr", "pos", "gene", "barcode"])
for barcode in ROI_data:
    barcodeX = ROI_data[barcode].copy()
    barcodeX.insert(len(barcodeX.columns), "barcode", barcode)
    # print(barcodeX.head)
    full_ROI_data = pd.concat([full_ROI_data, barcodeX], join="inner", ignore_index=True, sort=False)
    
print(full_ROI_data.head(10))
```
Nu zijn alle barcodes in een dataframe. Deze code werkt ook allemaal op de ALL data. 
***NOTE: Deze code is nog wel een beetje langzaam, misschien kan dit nog worden verbeterd***


*Nov 28 2024*

Ik heb nagedacht over het probleem met de genen, en ik denk dat ik heb misschien kan oplossen door een referentie sequentie te gebruiken. Als ik een referentie heb waarbij wel de genen staan naast de positie kan ik de positie van het begin van het gen nemen en dan gokken hoe lang daarvoor de promoter regio van dat gen dan zit (neem bijvoorbeeld aan dat de promoter regio binnen -1000 van het begin van het gen zit). Daarvoor heb ik de geannoteerde genen nodig van NCBI die je [hier](https://www.ncbi.nlm.nih.gov/datasets/gene/GCF_000001405.40/) kan downloaden, als je die download heb je wel een heel groot bestand.


*Dec 3 2024*

Ik heb een bestand gedownload, die is kleiner dan ik had verwacht (zo'n 8 Mb). Daarvan heb ik uiteindelijk maar een paar colommen nodig: Begin, End, Chromosome, Orientation(misschien) en Symbol/Gene ID

Ik kan gelukkig met read_csv gelijk de colommen die ik niet nodig heb weglaten
```{python}
gene_loc_file = pd.read_csv("../Data/ncbi_dataset.tsv", sep = "\t", usecols=["Begin", "End", "Chromosome", "Orientation", "Symbol", "Gene ID"])
print(gene_loc_file.head(10))
```

*Dec 4 2024*

Vandaag wil ik beginnen met panel.

Ik heb het idee om een tekst input veld te maken voor het lezen van een gen naam en op basis van de tekst die wordt getypt een dropdown te maken die alle mogelijke genen geeft. Ik kan waarschijnlijk ook iets vergelijkbaars doen met een chromosoom input.

```{python}
pn.extension()
gene_input = pn.widgets.TextInput(name="Gene name", placeholder="text input here")
gene_input.enter_pressed
```
```{python}

gene_options = list(set(gene_loc_file["Symbol"]))

gene_selector = pn.widgets.Select(name="Gene Select", options=)
gene_selector
```

```{python}
input_gene = "DDX11L1"

input_gene_info = gene_loc_file[gene_loc_file["Symbol"] == input_gene]

promotor = 0

if input_gene_info["Orientation"] == "plus":
    promotor = range(input_gene_info.iat[0, 0] - 1000, input_gene_info.iat[0, 1])
else:
    promotor = range(input_gene_info.iat[0, 0], input_gene_info.iat[0, 1] + 1000)
    
print(promotor)

```



